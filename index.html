<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DChat | Private & Secure</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b51ff; /* Purple */
            --secondary: #00d2ff; /* Cyan */
            --bg: #0e1621; /* Dark Telegram Blue */
            --surface: #17212b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); color: white; height: 100vh; display: flex; justify-content: center; }

        /* --- UI Screens --- */
        .screen { width: 100%; max-width: 500px; display: none; flex-direction: column; background: var(--surface); position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .active-screen { display: flex; }

        /* --- Login Screen --- */
        #login-screen { justify-content: center; align-items: center; padding: 30px; background: radial-gradient(circle at top, #1e293b, #0e1621); }
        .login-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(15px); padding: 40px; border-radius: 30px; width: 100%; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        
        .profile-picker { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; }
        #preview-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); padding: 5px; }
        .cam-badge { position: absolute; bottom: 5px; right: 5px; background: var(--primary); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid var(--surface); }

        input { width: 100%; padding: 14px; margin: 15px 0; border-radius: 12px; border: 1px solid #2c3e50; background: #0e1621; color: white; outline: none; }
        .btn-join { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 5px 15px rgba(139, 81, 255, 0.3); }

        /* --- Chat Screen --- */
        header { padding: 15px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #101921; z-index: 10; }
        .header-user { display: flex; align-items: center; gap: 12px; }
        #nav-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 85%; font-size: 14px; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .sent { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #242f3d; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* --- Video Display --- */
        #video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 100px; right: 20px; width: 110px; border-radius: 15px; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .controls { padding: 15px; background: var(--surface); display: flex; gap: 10px; align-items: center; }
        .controls input { margin: 0; }
        .btn-circle { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        .id-badge { background: rgba(0, 210, 255, 0.1); color: var(--secondary); padding: 5px 12px; border-radius: 20px; font-size: 11px; margin: 10px auto; display: inline-block; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active-screen">
        <div class="login-card">
            <h1 style="color:var(--primary); margin-bottom:10px;">DChat</h1>
            <p style="color:#8a99a7; font-size:14px;">Connect karo, Baat karo!</p>
            
            <div class="profile-picker">
                <img id="preview-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                <label for="img-upload" class="cam-badge"><i class="fas fa-camera"></i></label>
                <input type="file" id="img-upload" style="display:none;" accept="image/*">
            </div>

            <input type="text" id="user-name" placeholder="Apna Naam Daalein">
            <button class="btn-join" onclick="enterApp()">Join DChat <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="main-app" class="screen">
        <div id="video-overlay">
            <video id="remote-video" autoplay></video>
            <video id="local-video" autoplay muted></video>
            <div style="position:absolute; bottom:30px; left:0; width:100%; display:flex; justify-content:center;">
                <button onclick="endCall()" style="background:#ff3b30; border:none; padding:18px; border-radius:50%; color:white; font-size:20px; cursor:pointer;"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>

        <header>
            <div class="header-user">
                <img id="nav-avatar" src="">
                <div>
                    <div id="display-name" style="font-weight:bold;">User</div>
                    <div style="font-size:11px; color:#22c55e;">‚óè Online</div>
                </div>
            </div>
            <div style="display:flex; gap:20px; color:#8a99a7;">
                <i class="fas fa-video" onclick="initCall()" style="cursor:pointer; color:var(--secondary)"></i>
                <i class="fas fa-sign-out-alt" onclick="location.reload()" style="cursor:pointer;"></i>
            </div>
        </header>

        <div id="chat-window">
            <center><div class="id-badge">Aapki DChat ID: <b id="my-peer-id">...</b></div></center>
            </div>

        <div class="controls">
            <i class="far fa-smile" style="font-size:22px; color:#8a99a7;"></i>
            <input type="text" id="chat-msg" placeholder="Message...">
            <button class="btn-circle" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const peer = new Peer();
        let currentConn, myStream;

        // Profile Photo Logic
        document.getElementById('img-upload').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = () => {
                document.getElementById('preview-img').src = reader.result;
                document.getElementById('nav-avatar').src = reader.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // App Entrance
        function enterApp() {
            const name = document.getElementById('user-name').value;
            if(!name) return alert("Bhai, naam toh batao!");
            
            document.getElementById('display-name').innerText = name;
            document.getElementById('login-screen').classList.remove('active-screen');
            document.getElementById('main-app').classList.add('active-screen');

            // Start Camera in background
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(s => {
                myStream = s;
                document.getElementById('local-video').srcObject = s;
            });
        }

        // PeerJS Event Listeners
        peer.on('open', id => document.getElementById('my-peer-id').innerText = id);

        // Receive Chat
        peer.on('connection', c => {
            currentConn = c;
            c.on('data', data => addBubble(data, 'received'));
        });

        // Receive Video Call
        peer.on('call', call => {
            document.getElementById('video-overlay').style.display = 'block';
            call.answer(myStream);
            call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
        });

        // Send Chat
        function sendMessage() {
            const val = document.getElementById('chat-msg').value;
            if(!val) return;

            if(!currentConn) {
                const targetId = prompt("Dost ki ID paste karein connect karne ke liye:");
                if(targetId) {
                    currentConn = peer.connect(targetId);
                    currentConn.on('open', () => {
                        currentConn.send(val);
                        addBubble(val, 'sent');
                    });
                }
            } else {
                currentConn.send(val);
                addBubble(val, 'sent');
            }
            document.getElementById('chat-msg').value = "";
        }

        // Make Video Call
        function initCall() {
            const targetId = prompt("Kise video call karna hai? Unki ID daalein:");
            if(targetId) {
                document.getElementById('video-overlay').style.display = 'block';
                const call = peer.call(targetId, myStream);
                call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
            }
        }

        function addBubble(txt, type) {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerText = txt;
            document.getElementById('chat-window').appendChild(div);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        }

        function endCall() {
            document.getElementById('video-overlay').style.display = 'none';
        }
    </script>
</body>
</html>
